{% extends 'master.html' %}

{% block title %}My Dashboard{% endblock %}

{% block intro %}
<div class="site-blocks-cover overlay" style="background-image: url(/static/images/hero_1.jpg)" data-aos="fade" data-stellar-background-ratio="0.5">
    <div class="container">
      <div class="row align-items-center justify-content-center">
        <div class="col-md-7 text-center" data-aos="fade">
          <h1 class="mb-2">My Dashboard</h1>
        </div>
      </div>
    </div>
  </div>  
{% endblock %}

{% block body %}
  <div class="site-section bg-light">
    <div class="container">
      <h3>{{errors}}</h3>
      <div class="row">
        
        
        <div class="col-lg-4 col-md-4 col-sm-10">
          {% if payments %}
            <p>Most Recent Payment:</p>
            {% for payment in payments %}

                <h4>Room: {{payment.room.name}} ({{payment.room.room_type.capacity}} in a room)</h4>
                <p>Payment Status: <strong>{{payment.status}}</strong></p>
                <p>Amount Paid: <strong>{{payment.amount}}</strong></p>
                <!-- <p>Duration Type: <strong>{{payment.reservation.duration_type}}</strong></p> -->

                <a href="{% url 'my-payments' %}">View Payments</a>

            {% endfor %}
            <hr>
            <br>
          {% else %}
            <strong>NO PAYMENT HISTORY FOUND!</strong>
          {% endif %}
          {% if reservations %}
            <p>Below is your reservation. Would you like to make payment?</p>
            <p>Note: Your reservation is only considered complete after payment is made (atleast 50%)!</p>
              {% for reservation in reservations %}
                <h4>Room: {{reservation.room.name}} ({{reservation.room.room_type.capacity}} in a room)</h4>
                <p>Duration Type: <strong>{{reservation.duration_type}}</strong></p>
                <p>Duration: <strong>{{reservation.duration}}</strong></p>
                <!-- Default input -->
              <div class="form-group">
                  <label for="exampleForm2">Amount</label>
                  <input type="currency" id="pay_amount" class="form-control" value="{{amount}}">
                  <span class="helptext">NB: 1.95% transaction charge included</span>
              </div>
              <div class="form-group">
                <button class="btn btn-primary" onclick="payWithPaystack('{{reservation.pk}}', '{{reservation.room.pk}}')">Make Payment</button>
                <a href="{% url 'delete_reservation' reservation.pk %}" class="btn btn-secondary">Cancel Reservation</a>
              </div>
              {% endfor %}
          {% endif %}
        </div>
        
        <div class="col-lg-8 col-md-8 col-sm-10">
        {% if not errors and payments  %}
          <!-- accordion -->
          <div id="accordion">
            <div class="card">
              
              <div class="card-header">
                <a class="card-link" data-toggle="collapse" href="#collapseOne">
                  Recent Announcements
                </a>
              </div>
              {% if announcements %}
               
                  <!-- add 'show' to class to make it show -->
                  <div id="collapseOne" class="collapse show" data-parent="#accordion">
                    <div class="card-body">
                      {% for announcement in announcements %}
                      <a href="#"><strong>{{announcement.title}}</strong></a>
                      <p>{{announcement.message}}</p>
                      {% endfor %}
                    </div>
                  </div>
                
              {% else %}
              <div id="collapseOne" class="collapse show" data-parent="#accordion">
                <div class="card-body">
                  <p>No anouncements</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          <!-- end accordion -->
          <a href="{% url 'coming_soon' %}">View all Announcements</a>
        {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endblock %}

  {% block jsfunctions %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script> 

  <script>

    function payWithPaystack(reservation, room) {
      var token = "{{ csrf_token }}"

      $.ajax({
        headers:{'X-CSRFToken': token},
            url: "check-room-availability/"+room+"/",
            method:'POST',
            data:{'room':room},
            success: function (response) {
              if(response.status=="available"){

                amount = "{{amount}}"
                if($('#pay_amount').val() < 0.5 * amount){
                  Swal.fire(
                  'Sorry!',
                  `The minimum payment is 50% ( ${amount / 2} ) of the room price`,
                  'error'
                  )
                  return
                }

                let handler = PaystackPop.setup({
                key: 'pk_test_f513574d567ae76bdc002e2ee4fe74bc7c6e566a', // Replace with your public key
                email: "{{user.email}}",
                amount: amount * 100, //always multiply by 100
                currency:"GHS",
                firstname: "{{user.first_name}}",
                lastname: "{{user.last_name}}",
                onClose: function(){
                  console.log('Window closed.');
                },
                callback: function(response){

                  // execute the alert
                  let timerInterval
                  Swal.fire({
                    title: 'Loading!',
                    html: 'Please give us a minute to verify the payment.',
                    timer: 20000,
                    allowOutsideClick:false,
                    timerProgressBar: true,
                    onBeforeOpen: () => {
                      Swal.showLoading()
                      timerInterval = setInterval(() => {
                        const content = Swal.getContent()
                        if (content) {
                          const b = content.querySelector('b')
                          if (b) {
                            b.textContent = Swal.getTimerLeft()
                          }
                        }
                      }, 100)
                    },
                    onClose: () => {
                      clearInterval(timerInterval)
                    }
                  }).then((result) => {
                    /* Read more about handling dismissals below */
                    if (result.dismiss === Swal.DismissReason.timer) {
                      console.log('I was closed by the timer')
                    }
                  })


                  $.ajax({
                    url: "/hostel/verify_transaction?response="+response.reference+"&res="+reservation+"&room="+room,
                    success: function (response) {
                      // the transaction status is in response.data.status
                      if(response.data.status=="success"){

                        window.location.href= "{% url 'dashboard' %}"
                      }else{
                        Swal.fire(
                          'Sorry!',
                          'Your payment verification failed! Contact the Charlotte Team for assistance',
                          'error'
                        )
                      }
                    },
                    error: function(response){
                      alert('error')
                    }
                  });
                }
              });
              handler.openIframe();

              }else{
                Swal.fire(
                  'Sorry!',
                  'The room has been fully booked. Kindly cancel the reservation and try another room',
                  'error'
                )
              }
            },
            error: function(response){
              alert('error')
            }
          });

        return


      
    }
  </script>
  {% endblock %}
